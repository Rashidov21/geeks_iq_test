{% extends 'iq_test/base.html' %}

{% block title %}IQ Test - Geeks Andijan{% endblock %}

{% block content %}
<style>
    /* Anti-cheat: matn tanlash va drag blok (faqat test sahifasida) */
    #test-container,
    #test-container * {
        -webkit-user-select: none;
        user-select: none;
        -webkit-touch-callout: none;
    }
    #test-container input[type="radio"],
    #test-container button {
        -webkit-user-select: none;
        user-select: none;
    }
    #question-image {
        pointer-events: none;
        -webkit-user-drag: none;
        user-select: none;
    }
</style>
<div id="test-container" class="min-h-screen py-4 px-3 sm:py-6 sm:px-4" data-results-url="{% url 'iq_test:results' %}">
    <!-- Header with progress and timer -->
    <div class="max-w-2xl mx-auto mb-4 sm:mb-6">
        <div class="flex flex-wrap justify-between items-center gap-2 mb-2">
            <span id="progress-text" class="font-medium text-geeks-gray">Savol 1 / <span id="total-questions">0</span></span>
            <div class="flex items-center gap-2 bg-geeks-yellow/20 px-3 py-1.5 rounded-lg border border-geeks-yellow/30">
                <span class="text-geeks-yellow text-lg">⏱️</span>
                <span id="timer" class="font-bold text-geeks-yellow">1:00</span>
            </div>
        </div>
        <div class="h-2 bg-white/10 rounded-full overflow-hidden">
            <div id="progress-bar" class="h-full bg-geeks-green rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
    </div>

    <!-- Question card -->
    <div id="question-card" class="max-w-2xl mx-auto bg-white/5 rounded-lg border border-white/10 overflow-hidden">
        <div id="question-content" class="p-4 sm:p-6 md:p-8">
            <!-- Loading state -->
            <div id="loading" class="text-center py-16">
                <div class="inline-block w-12 h-12 border-4 border-geeks-green border-t-transparent rounded-full animate-spin mb-4"></div>
                <p class="text-geeks-gray">Savollar yuklanmoqda...</p>
            </div>

            <!-- Question (populated by JS) -->
            <div id="question-area" class="hidden">
                <p id="question-type-badge" class="text-xs font-medium text-geeks-gray mb-2"></p>
                <h2 id="question-text" class="text-base sm:text-xl font-bold text-white mb-3 sm:mb-4"></h2>
                <div id="question-image-wrap" class="mb-4 sm:mb-6 hidden">
                    <img id="question-image" src="" alt="" class="max-w-full rounded-lg border border-white/10 mx-auto max-h-[200px] sm:max-h-[280px] object-contain">
                </div>
                <div id="options" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
                <div class="flex gap-3 mt-4 sm:mt-6">
                    <button type="button" id="skip-btn" class="min-h-[44px] px-4 py-2.5 border-2 border-white/20 rounded-lg font-medium text-geeks-gray hover:bg-white/5 transition-colors touch-manipulation">
                        O'tkazib yuborish →
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div id="nav-buttons" class="max-w-2xl mx-auto mt-4 sm:mt-6 flex justify-between gap-3 hidden">
        <button type="button" id="prev-btn" class="min-h-[44px] flex-1 sm:flex-none px-4 sm:px-6 py-2.5 border-2 border-white/20 rounded-lg font-medium text-white hover:bg-white/5 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-transparent transition-colors touch-manipulation">
            ← Oldingi
        </button>
        <button type="button" id="next-btn" class="min-h-[44px] flex-1 sm:flex-none px-4 sm:px-6 py-2.5 bg-geeks-purple text-white rounded-lg font-bold hover:opacity-90 transition-opacity touch-manipulation">
            Keyingi →
        </button>
    </div>

    <!-- Submit area -->
    <div id="submit-area" class="max-w-2xl mx-auto mt-6 sm:mt-8 text-center hidden">
        <div id="submit-error" class="mb-4 hidden p-4 bg-red-500/20 border border-red-500/50 text-red-400 rounded-lg text-sm"></div>
        <button type="button" id="submit-btn" class="min-h-[48px] w-full sm:w-auto px-8 sm:px-12 py-4 bg-geeks-green text-geeks-dark font-bold text-lg rounded-lg hover:opacity-90 transition-opacity disabled:opacity-70 disabled:cursor-not-allowed uppercase touch-manipulation">
            Natijani ko'rish
        </button>
    </div>
</div>

<input type="hidden" id="csrf-token" value="{{ csrf_token }}">
<script>
(function() {
    const csrfToken = document.getElementById('csrf-token').value;
    const questionsUrl = '{% url "iq_test:get_questions" %}';
    const submitUrl = '{% url "iq_test:submit_test" %}';
    const timePerQuestion = 60; // 1 daqiqa (anti-cheat)

    let questions = [];
    let currentIndex = 0;
    let answers = {};
    let timerInterval = null;
    let timeRemaining = timePerQuestion;
    let totalTimeSpent = 0;

    const loadingEl = document.getElementById('loading');
    const questionArea = document.getElementById('question-area');
    const questionText = document.getElementById('question-text');
    const optionsEl = document.getElementById('options');
    const progressText = document.getElementById('progress-text');
    const progressBar = document.getElementById('progress-bar');
    const totalQuestionsEl = document.getElementById('total-questions');
    const timerEl = document.getElementById('timer');
    const skipBtn = document.getElementById('skip-btn');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const submitArea = document.getElementById('submit-area');
    const submitBtn = document.getElementById('submit-btn');

    function formatTime(sec) {
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return `${m}:${s.toString().padStart(2, '0')}`;
    }

    function startTimer() {
        timeRemaining = timePerQuestion;
        timerEl.textContent = formatTime(timeRemaining);
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeRemaining--;
            totalTimeSpent++;
            timerEl.textContent = formatTime(timeRemaining);
            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                goNext();
            }
        }, 1000);
    }

    function stopTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
    }

    const typeLabels = { text: 'Matnli savol', raven: "Raven matritsasi", abstract: 'Abstract reasoning', visual: 'Visual puzzle' };

    function renderQuestion() {
        const q = questions[currentIndex];
        if (!q) return;

        document.getElementById('question-type-badge').textContent = typeLabels[q.question_type] || q.question_type;
        questionText.textContent = q.text || 'Bo\'sh joyni to\'ldiring. To\'g\'ri variantni tanlang.';

        const imgWrap = document.getElementById('question-image-wrap');
        const imgEl = document.getElementById('question-image');
        if (q.image) {
            imgWrap.classList.remove('hidden');
            imgEl.src = q.image;
            imgEl.alt = q.text || 'Savol rasmi';
        } else {
            imgWrap.classList.add('hidden');
        }

        optionsEl.innerHTML = '';
        (q.options || []).forEach((opt, i) => {
            const letter = opt.letter;
            const isSelected = answers[q.id] === letter;
            const div = document.createElement('label');
            div.className = `flex items-center gap-3 p-3 sm:p-4 rounded-lg border-2 cursor-pointer transition-all min-h-[52px] sm:min-h-[56px] text-white touch-manipulation ${isSelected ? 'border-geeks-green bg-geeks-green/20' : 'border-white/20 hover:border-white/40 bg-white/5'}`;
            div.innerHTML = `<input type="radio" name="answer" value="${letter}" ${isSelected ? 'checked' : ''} class="w-5 h-5 text-geeks-green shrink-0">
                <span class="font-medium shrink-0">${letter.toUpperCase()}.</span>`;
            if (opt.image) {
                const img = document.createElement('img');
                img.src = opt.image;
                img.alt = '';
                img.className = 'w-16 h-16 sm:w-20 sm:h-20 md:w-24 md:h-24 object-contain rounded border border-white/10 shrink-0';
                div.appendChild(img);
            }
            if (opt.text) {
                const span = document.createElement('span');
                span.textContent = opt.text;
                span.className = 'break-words';
                div.appendChild(span);
            }
            div.addEventListener('click', () => {
                answers[q.id] = letter;
                document.querySelectorAll('#options label').forEach(l => l.classList.remove('border-geeks-green', 'bg-geeks-green/20'));
                div.classList.add('border-geeks-green', 'bg-geeks-green/20');
            });
            optionsEl.appendChild(div);
        });

        // Update progress
        const pct = ((currentIndex + 1) / questions.length) * 100;
        progressBar.style.width = pct + '%';
        progressText.innerHTML = `Savol ${currentIndex + 1} / <span id="total-questions">${questions.length}</span>`;

        // Nav visibility
        prevBtn.parentElement.classList.remove('hidden');
        prevBtn.disabled = currentIndex === 0;
        nextBtn.textContent = currentIndex === questions.length - 1 ? 'Yakunlash' : 'Keyingi →';
        submitArea.classList.add('hidden');
        if (currentIndex === questions.length - 1) {
            nextBtn.classList.add('hidden');
            submitArea.classList.remove('hidden');
        } else {
            nextBtn.classList.remove('hidden');
        }

        startTimer();
    }

    function goNext() {
        stopTimer();
        if (currentIndex < questions.length - 1) {
            currentIndex++;
            renderQuestion();
        }
    }

    function goPrev() {
        stopTimer();
        if (currentIndex > 0) {
            currentIndex--;
            renderQuestion();
        }
    }

    async function loadQuestions() {
        try {
            const res = await fetch(questionsUrl);
            const data = await res.json();
            questions = data.questions || [];
            if (questions.length === 0) {
                loadingEl.innerHTML = '<p class="text-red-400">Hozircha savollar mavjud emas. Administrator bilan bog\'laning.</p>';
                return;
            }
            loadingEl.classList.add('hidden');
            questionArea.classList.remove('hidden');
            totalQuestionsEl.textContent = questions.length;
            renderQuestion();
        } catch (e) {
            loadingEl.innerHTML = '<p class="text-red-400">Xatolik yuz berdi. Qaytadan urinib ko\'ring.</p>';
        }
    }

    skipBtn.addEventListener('click', goNext);
    prevBtn.addEventListener('click', goPrev);
    nextBtn.addEventListener('click', () => {
        if (currentIndex === questions.length - 1) {
            submitTest();
        } else {
            goNext();
        }
    });

    const submitErrorEl = document.getElementById('submit-error');
    function showSubmitError(msg) {
        submitErrorEl.textContent = msg;
        submitErrorEl.classList.remove('hidden');
    }
    function hideSubmitError() {
        submitErrorEl.classList.add('hidden');
    }

    async function submitTest() {
        stopTimer();
        hideSubmitError();
        submitBtn.disabled = true;
        submitBtn.textContent = 'Yuborilmoqda...';
        try {
            const res = await fetch(submitUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ answers, time_spent: totalTimeSpent })
            });
            const data = await res.json();
            if (data.success) {
                window.onbeforeunload = null;
                const resultsUrl = document.getElementById('test-container').getAttribute('data-results-url');
                window.location.href = resultsUrl || '/results/';
            } else {
                showSubmitError(data.error || 'Xatolik yuz berdi. Qaytadan urinib ko\'ring.');
            }
        } catch (e) {
            showSubmitError('Xatolik yuz berdi. Internet aloqangizni tekshiring va qaytadan urinib ko\'ring.');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Natijani ko\'rish';
        }
    }

    submitBtn.addEventListener('click', submitTest);

    window.addEventListener('beforeunload', (e) => {
        if (questions.length > 0 && !document.querySelector('#submit-btn:disabled')) {
            e.preventDefault();
        }
    });

    // Anti-cheat: o'ng tugma (kontekst menyu), copy, F12 va boshqa tugmalarni bloklash
    document.addEventListener('contextmenu', (e) => e.preventDefault());
    document.addEventListener('copy', (e) => e.preventDefault());
    document.addEventListener('cut', (e) => e.preventDefault());
    document.addEventListener('selectstart', (e) => e.preventDefault());
    document.addEventListener('keydown', (e) => {
        if (e.key === 'F12' || e.key === 'PrintScreen' ||
            (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) ||
            (e.ctrlKey && (e.key === 'u' || e.key === 'U' || e.key === 's' || e.key === 'S')) ||
            (e.metaKey && (e.key === 'u' || e.key === 'U' || e.key === 's' || e.key === 'S'))) {
            e.preventDefault();
        }
    });

    loadQuestions();
})();
</script>
{% endblock %}
