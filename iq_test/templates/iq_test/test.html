{% extends 'iq_test/base.html' %}

{% block title %}IQ Test - Geeks Andijan{% endblock %}

{% block content %}
<div id="test-container" class="min-h-screen py-6 px-4">
    <!-- Header with progress and timer -->
    <div class="max-w-2xl mx-auto mb-6">
        <div class="flex justify-between items-center mb-2">
            <span id="progress-text" class="font-medium text-slate-600">Savol 1 / <span id="total-questions">0</span></span>
            <div class="flex items-center gap-2 bg-amber-50 px-3 py-1.5 rounded-lg">
                <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span id="timer" class="font-bold text-amber-700">2:00</span>
            </div>
        </div>
        <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
            <div id="progress-bar" class="h-full bg-emerald-500 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
    </div>

    <!-- Question card -->
    <div id="question-card" class="max-w-2xl mx-auto bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden">
        <div id="question-content" class="p-8">
            <!-- Loading state -->
            <div id="loading" class="text-center py-16">
                <div class="inline-block w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                <p class="text-slate-600">Savollar yuklanmoqda...</p>
            </div>

            <!-- Question (populated by JS) -->
            <div id="question-area" class="hidden">
                <p id="question-type-badge" class="text-xs font-medium text-slate-500 mb-2"></p>
                <h2 id="question-text" class="text-xl font-bold text-slate-800 mb-4"></h2>
                <div id="question-image-wrap" class="mb-6 hidden">
                    <img id="question-image" src="" alt="" class="max-w-full rounded-xl border border-slate-200 mx-auto" style="max-height: 280px;">
                </div>
                <div id="options" class="space-y-3"></div>
                <div class="flex gap-3 mt-6">
                    <button type="button" id="skip-btn" class="px-4 py-2 border-2 border-slate-300 rounded-xl font-medium text-slate-600 hover:bg-slate-50 transition-colors">
                        O'tkazib yuborish →
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div id="nav-buttons" class="max-w-2xl mx-auto mt-6 flex justify-between hidden">
        <button type="button" id="prev-btn" class="px-6 py-2 border-2 border-slate-300 rounded-xl font-medium hover:bg-slate-50">
            ← Oldingi
        </button>
        <button type="button" id="next-btn" class="px-6 py-2 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700">
            Keyingi →
        </button>
    </div>

    <!-- Submit area -->
    <div id="submit-area" class="max-w-2xl mx-auto mt-8 text-center hidden">
        <button type="button" id="submit-btn" class="px-12 py-4 bg-emerald-600 text-white font-bold text-lg rounded-xl hover:bg-emerald-700 transition-colors">
            Natijani ko'rish
        </button>
    </div>
</div>

<input type="hidden" id="csrf-token" value="{{ csrf_token }}">
<script>
(function() {
    const csrfToken = document.getElementById('csrf-token').value;
    const questionsUrl = '{% url "iq_test:get_questions" %}';
    const submitUrl = '{% url "iq_test:submit_test" %}';
    const timePerQuestion = 30; // seconds

    let questions = [];
    let currentIndex = 0;
    let answers = {};
    let timerInterval = null;
    let timeRemaining = timePerQuestion;
    let totalTimeSpent = 0;

    const loadingEl = document.getElementById('loading');
    const questionArea = document.getElementById('question-area');
    const questionText = document.getElementById('question-text');
    const optionsEl = document.getElementById('options');
    const progressText = document.getElementById('progress-text');
    const progressBar = document.getElementById('progress-bar');
    const totalQuestionsEl = document.getElementById('total-questions');
    const timerEl = document.getElementById('timer');
    const skipBtn = document.getElementById('skip-btn');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const submitArea = document.getElementById('submit-area');
    const submitBtn = document.getElementById('submit-btn');

    function formatTime(sec) {
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return `${m}:${s.toString().padStart(2, '0')}`;
    }

    function startTimer() {
        timeRemaining = timePerQuestion;
        timerEl.textContent = formatTime(timeRemaining);
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeRemaining--;
            totalTimeSpent++;
            timerEl.textContent = formatTime(timeRemaining);
            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                goNext();
            }
        }, 1000);
    }

    function stopTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
    }

    const typeLabels = { text: 'Matnli savol', raven: "Raven matritsasi", abstract: 'Abstract reasoning', visual: 'Visual puzzle' };

    function renderQuestion() {
        const q = questions[currentIndex];
        if (!q) return;

        document.getElementById('question-type-badge').textContent = typeLabels[q.question_type] || q.question_type;
        questionText.textContent = q.text || 'Bo\'sh joyni to\'ldiring. To\'g\'ri variantni tanlang.';

        const imgWrap = document.getElementById('question-image-wrap');
        const imgEl = document.getElementById('question-image');
        if (q.image) {
            imgWrap.classList.remove('hidden');
            imgEl.src = q.image;
            imgEl.alt = q.text || 'Savol rasmi';
        } else {
            imgWrap.classList.add('hidden');
        }

        optionsEl.innerHTML = '';
        (q.options || []).forEach((opt, i) => {
            const letter = opt.letter;
            const isSelected = answers[q.id] === letter;
            const div = document.createElement('label');
            div.className = `flex items-center gap-3 p-4 rounded-xl border-2 cursor-pointer transition-all ${isSelected ? 'border-emerald-500 bg-emerald-50' : 'border-slate-200 hover:border-slate-300'}`;
            let content = `<input type="radio" name="answer" value="${letter}" ${isSelected ? 'checked' : ''} class="w-5 h-5 text-emerald-600 shrink-0">
                <span class="font-medium shrink-0">${letter.toUpperCase()}.</span>`;
            if (opt.image) {
                content += `<img src="${opt.image}" alt="" class="w-12 h-12 object-contain rounded border border-slate-200">`;
            }
            if (opt.text) {
                content += `<span>${opt.text}</span>`;
            }
            div.innerHTML = content;
            div.addEventListener('click', () => {
                answers[q.id] = letter;
                document.querySelectorAll('#options label').forEach(l => l.classList.remove('border-emerald-500', 'bg-emerald-50'));
                div.classList.add('border-emerald-500', 'bg-emerald-50');
            });
            optionsEl.appendChild(div);
        });

        // Update progress
        const pct = ((currentIndex + 1) / questions.length) * 100;
        progressBar.style.width = pct + '%';
        progressText.innerHTML = `Savol ${currentIndex + 1} / <span id="total-questions">${questions.length}</span>`;

        // Nav visibility
        prevBtn.parentElement.classList.remove('hidden');
        prevBtn.disabled = currentIndex === 0;
        nextBtn.textContent = currentIndex === questions.length - 1 ? 'Yakunlash' : 'Keyingi →';
        submitArea.classList.add('hidden');
        if (currentIndex === questions.length - 1) {
            nextBtn.classList.add('hidden');
            submitArea.classList.remove('hidden');
        } else {
            nextBtn.classList.remove('hidden');
        }

        startTimer();
    }

    function goNext() {
        stopTimer();
        if (currentIndex < questions.length - 1) {
            currentIndex++;
            renderQuestion();
        }
    }

    function goPrev() {
        stopTimer();
        if (currentIndex > 0) {
            currentIndex--;
            renderQuestion();
        }
    }

    async function loadQuestions() {
        try {
            const res = await fetch(questionsUrl);
            const data = await res.json();
            questions = data.questions || [];
            if (questions.length === 0) {
                loadingEl.innerHTML = '<p class="text-red-600">Hozircha savollar mavjud emas. Administrator bilan bog\'laning.</p>';
                return;
            }
            loadingEl.classList.add('hidden');
            questionArea.classList.remove('hidden');
            totalQuestionsEl.textContent = questions.length;
            renderQuestion();
        } catch (e) {
            loadingEl.innerHTML = '<p class="text-red-600">Xatolik yuz berdi. Qaytadan urinib ko\'ring.</p>';
        }
    }

    skipBtn.addEventListener('click', goNext);
    prevBtn.addEventListener('click', goPrev);
    nextBtn.addEventListener('click', () => {
        if (currentIndex === questions.length - 1) {
            submitTest();
        } else {
            goNext();
        }
    });

    async function submitTest() {
        stopTimer();
        submitBtn.disabled = true;
        submitBtn.textContent = 'Yuborilmoqda...';
        try {
            const res = await fetch(submitUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ answers, time_spent: totalTimeSpent })
            });
            const data = await res.json();
            if (data.success) {
                window.location.href = '/results/';
            } else {
                alert(data.error || 'Xatolik yuz berdi');
            }
        } catch (e) {
            alert('Xatolik yuz berdi. Qaytadan urinib ko\'ring.');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Natijani ko\'rish';
        }
    }

    submitBtn.addEventListener('click', submitTest);

    loadQuestions();
})();
</script>
{% endblock %}
