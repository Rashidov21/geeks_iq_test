{% extends 'iq_test/base.html' %}

{% block title %}O'qituvchi paneli - Geeks Andijan IQ Test{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-100">
    <header class="bg-white border-b border-slate-200 sticky top-0 z-10">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="font-bold text-xl text-slate-800">O'qituvchi paneli</h1>
            <div class="flex gap-3">
                <a href="{% url 'iq_test:export_csv' %}" class="px-4 py-2 bg-slate-600 text-white rounded-lg text-sm font-medium hover:bg-slate-700">
                    CSV yuklab olish
                </a>
                <a href="{% url 'iq_test:export_excel' %}" class="px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm font-medium hover:bg-emerald-700">
                    Excel yuklab olish
                </a>
                <a href="{% url 'iq_test:landing' %}" class="px-4 py-2 text-slate-600 hover:text-slate-800 text-sm">
                    Test sahifasi
                </a>
                <a href="/admin/" target="_blank" class="px-4 py-2 text-slate-600 hover:text-slate-800 text-sm">
                    Admin
                </a>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <!-- Stats cards -->
        <div class="grid md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow p-6 border border-slate-100">
                <p class="text-slate-600 text-sm font-medium">Jami testlar</p>
                <p class="text-3xl font-bold text-emerald-600 mt-1">{{ total_attempts }}</p>
            </div>
            <div class="bg-white rounded-xl shadow p-6 border border-slate-100">
                <p class="text-slate-600 text-sm font-medium">O'rtacha ball</p>
                <p class="text-3xl font-bold text-teal-600 mt-1">{{ avg_score }}</p>
            </div>
            <div class="bg-white rounded-xl shadow p-6 border border-slate-100">
                <p class="text-slate-600 text-sm font-medium">Eng yaxshi natija</p>
                <p class="text-3xl font-bold text-amber-600 mt-1">{% if top_3 %}{{ top_3.0.score }}{% else %}-{% endif %}</p>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid md:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow p-6 border border-slate-100">
                <h2 class="font-bold text-slate-800 mb-4">O'rtacha ball yosh bo'yicha</h2>
                <canvas id="chart-age" height="200"></canvas>
            </div>
            <div class="bg-white rounded-xl shadow p-6 border border-slate-100">
                <h2 class="font-bold text-slate-800 mb-4">O'rtacha ball jinsi bo'yicha</h2>
                <canvas id="chart-gender" height="200"></canvas>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow p-6 border border-slate-100 mb-8">
            <h2 class="font-bold text-slate-800 mb-4">Ball taqsimoti</h2>
            <canvas id="chart-dist" height="150"></canvas>
        </div>

        <!-- Top 3 -->
        <div class="bg-white rounded-xl shadow p-6 border border-slate-100 mb-8">
            <h2 class="font-bold text-slate-800 mb-4">Eng yaxshi 3 ta natija</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-slate-200 text-left text-slate-600 text-sm">
                            <th class="pb-3">#</th>
                            <th class="pb-3">Ism</th>
                            <th class="pb-3">Yosh</th>
                            <th class="pb-3">Jinsi</th>
                            <th class="pb-3">Ball</th>
                            <th class="pb-3">Sana</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in top_3 %}
                        <tr class="border-b border-slate-100">
                            <td class="py-3 font-bold">{{ forloop.counter }}</td>
                            <td class="py-3">{{ r.name }}</td>
                            <td class="py-3">{{ r.age }}</td>
                            <td class="py-3">{{ r.get_gender_display }}</td>
                            <td class="py-3 font-bold text-emerald-600">{{ r.score }}</td>
                            <td class="py-3 text-slate-600 text-sm">{{ r.created_at|date:"d.m.Y H:i" }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="6" class="py-8 text-center text-slate-500">Hali natija yo'q</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Last 10 -->
        <div class="bg-white rounded-xl shadow p-6 border border-slate-100 mb-8">
            <h2 class="font-bold text-slate-800 mb-4">Oxirgi 10 ta natija</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-slate-200 text-left text-slate-600 text-sm">
                            <th class="pb-3">Ism</th>
                            <th class="pb-3">Yosh</th>
                            <th class="pb-3">Jinsi</th>
                            <th class="pb-3">Telefon</th>
                            <th class="pb-3">Ball</th>
                            <th class="pb-3">Sana</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in last_10 %}
                        <tr class="border-b border-slate-100">
                            <td class="py-3">{{ r.name }}</td>
                            <td class="py-3">{{ r.age }}</td>
                            <td class="py-3">{{ r.get_gender_display }}</td>
                            <td class="py-3">{{ r.phone }}</td>
                            <td class="py-3 font-bold text-emerald-600">{{ r.score }}</td>
                            <td class="py-3 text-slate-600 text-sm">{{ r.created_at|date:"d.m.Y H:i" }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="6" class="py-8 text-center text-slate-500">Hali natija yo'q</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Full leaderboard -->
        <div class="bg-white rounded-xl shadow p-6 border border-slate-100">
            <h2 class="font-bold text-slate-800 mb-4">To'liq reyting (20 ta)</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-slate-200 text-left text-slate-600 text-sm">
                            <th class="pb-3">#</th>
                            <th class="pb-3">Ism</th>
                            <th class="pb-3">Yosh</th>
                            <th class="pb-3">Jinsi</th>
                            <th class="pb-3">Ball</th>
                            <th class="pb-3">Sana</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in leaderboard %}
                        <tr class="border-b border-slate-100">
                            <td class="py-3 font-bold">{{ forloop.counter }}</td>
                            <td class="py-3">{{ r.name }}</td>
                            <td class="py-3">{{ r.age }}</td>
                            <td class="py-3">{{ r.get_gender_display }}</td>
                            <td class="py-3 font-bold text-emerald-600">{{ r.score }}</td>
                            <td class="py-3 text-slate-600 text-sm">{{ r.created_at|date:"d.m.Y H:i" }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="6" class="py-8 text-center text-slate-500">Hali natija yo'q</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function() {
    const ageLabels = {{ age_labels|safe }};
    const ageScores = {{ age_scores|safe }};
    const genderLabels = {{ gender_labels|safe }};
    const genderScores = {{ gender_scores|safe }};
    const distLabels = {{ dist_labels|safe }};
    const distValues = {{ dist_values|safe }};

    if (ageLabels.length) {
        new Chart(document.getElementById('chart-age'), {
            type: 'bar',
            data: {
                labels: ageLabels,
                datasets: [{
                    label: 'O\'rtacha ball',
                    data: ageScores,
                    backgroundColor: 'rgba(5, 150, 105, 0.6)',
                    borderColor: 'rgb(5, 150, 105)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true, max: 100 }
                }
            }
        });
    }

    if (genderLabels.length) {
        new Chart(document.getElementById('chart-gender'), {
            type: 'doughnut',
            data: {
                labels: genderLabels,
                datasets: [{
                    data: genderScores,
                    backgroundColor: ['rgb(5, 150, 105)', 'rgb(20, 184, 166)']
                }]
            },
            options: { responsive: true }
        });
    }

    new Chart(document.getElementById('chart-dist'), {
        type: 'bar',
        data: {
            labels: distLabels,
            datasets: [{
                label: 'Testlar soni',
                data: distValues,
                backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#14b8a6']
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
})();
</script>
{% endblock %}
